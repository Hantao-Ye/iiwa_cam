# Kuka ROS Tutorial - Microservices

[Home](../README.md)

## Content
- [MoveIt! - RViz Support Services](#moveit---rviz-support-services)
- [End Effector State Services ](#end-effector-state-services)
    - [Current Cartesian Position](#end-effector-current-cartesian-position-inquiry)
    - [Path Recording](#end-effector-path-recording)
    - [Wrench Visulization](#end-effector-wrench-visulization)


## MoveIt! - RViz Support Services

 - **Service 1**: `moveit_rviz_state_receiver_service`  
   **Source File**: [moveit_rviz_state_receiver_service.cpp](../src/utilities/moveit_rviz_state_receiver_service.cpp)  
   **Description**: Get joint position from real robot (specified by robot name) and visualize the state on RVIZ

 - **Service 2**: `moveit_rviz_exec_service`  
   **Source File**: [moveit_rviz_exec_service.cpp](../src/utilities/moveit_rviz_exec_service.cpp)  
   **Description**: Get joint space trajectory plan by moveit, execute it (require specifying robot name)


-  **Note**: For multiple robots, you may need to change the source code of services above (the topic name that RViz publishes and receives)

  1. Load the manipulator into RViz:   
    `roslaunch iiwa_cam_moveit demo.launch`  
    Here we are using demo file (`demo.launch`) generated by the [MoveIt setup assistant](http://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/setup_assistant/setup_assistant_tutorial.html).   
    The  file is adapted to disable the default joint_state_publisher

  1. Visualize the real robot state on RVIZ:   
    `rosrun iiwa_cam moveit_rviz_state_receiver_service [robot name]`  

  1. Execute joint space trajectory plan by moveit:  
    `rosrun iiwa_cam moveit_rviz_exec_service [robot name]` 

  1. The above steps are integrated into a launch file [moveit_kuka.launch](../launch/moveit_kuka.launch), run it with:  
    `roslaunch iiwa_cam moveit_kuka.launch`

      ```xml
      <launch>

        <!-- run a modified moveit demo lauch file -->
        <!-- the node "joint_state_publisher" is disabled -->
        <include file="$(find iiwa_cam_moveit)/launch/demo.launch"/>

        <node pkg="iiwa_cam" type="moveit_rviz_exec_service" name="moveit_rviz_exec_service" output="screen"/>
      
        <node pkg="iiwa_cam" type="moveit_rviz_state_receiver_service" name="moveit_rviz_state_receiver_service" output="screen"/>

      </launch>

      ```


## End Effector State Services 

 - **Service**: `end_effector_state_service`  
 - **Source File**: [end_effector_state_service.cpp](../src/utilities/end_effector_state_service.cpp)  
 - **Run the microservice**:  
    `rosrun iiwa_cam end_effector_state_service [robot1 name] [robot2 name] ...`  

 ### End Effector Current Cartesian Position Inquiry
 To get the current cartesian position, there are two options:

  1. In a terminal:  
    call service `/cam/iiwa/EndEffectorState`, with parameters:   
    `robot_name: [robot name]`  

  1. In C++ program:  
    call `cam::Kuka::end_effector_state()::get_cart_pose()` 
      ```cpp
      auto cart_pose = kuka.end_effector_state().get_cart_pose();
      std::cout<<cart_pose.first<<std::endl;
      ```

### End Effector Path Recording

  **Watchdog Machanisim**:  
  - [Wikipedia: Watchdog timer](https://en.wikipedia.org/wiki/Watchdog_timer)
  - The watchdog machanisim is introduced to this server, which allows the server stop recording when a client crashes. Once the client setup a watchdog, it should feed the dog with a frequency higher than **0.2** Hz （recommend 4 seconds between two feeds)

  **Note**: The data is saved in your terminal's current working directory  
  - cartesian path: `[robot name]_cart_path.csv`  
  - wrench: `[robot name]_wrench.csv`  

  To record path of the end effector, there are three options:
  
  1.  In a terminal:
      - Start recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: true`  
      `watchdog: false`
      - Stop recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: false`  
      `watchdog: false`  

  1. In a terminal: (protected by the **watchdog machanisim**)  
      - Start recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: true`  
      `watchdog: true`

      - Feed dog by calling service `/cam/iiwa/PathRecorder`, with parameters:  
      （recommend 4 seconds between two feeds)  
      `robot_name: [robot name]`  
      `record: true`  
      `watchdog: true`

      - Stop recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: false`  
      `watchdog: true`  

  1.  In C++ program: (protected by the **watchdog machanisim**)  
    call `cam::Kuka::end_effector_state()::start_recording()` and `cam::Kuka::end_effector_state()::end_recording()`
      ```cpp
      kuka.end_effector_state().start_recording();
      // Do Something
      kuka.end_effector_state().end_recording();
      ```
    

### End Effector Wrench Visulization


  1. In terminal, run: (in order to load the manipulator into RViz, you can do this in other ways)  
    `roslaunch iiwa_cam moveit_kuka.launch`  


  1. In RVIZ, click "`Add`" button -> in the "`By topic`" tab -> select  
  `/[robot name]/state/EndEffectorWrench`













